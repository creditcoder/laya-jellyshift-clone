{
  "code": "import { ui } from \"./../ui/layaMaxUI\";\r\nimport TriggerCollisionScript from \"./../common/TriggerCollisionScript\";\r\nimport TriggerCollisionScript4Jewel from \"../common/TriggerCollisionScript4Jewel\";\r\nimport Player from \"./../script/Player\";\r\nimport SettingDlg from \"./../script/SettingDlg\";\r\nimport CustomizeDlg from \"./../script/CustomizeDlg\";\r\nimport ProgressView from \"./../script/ProgressView\";\r\nimport WorldDlg from \"./../script/WorldDlg\";\r\nimport GameInfo from \"./../script/GameInfo\";\r\nimport Food from \"./Food\";\r\nimport Sound from \"./Sound\";\r\nimport TriggerCollisionScript4Round from \"../common/TriggerCollisionScript4Round\";\r\nexport default class GameUI extends ui.GameSceneUI {\r\n    constructor() {\r\n        super();\r\n        this.settingDlg = null;\r\n        this.customizeDlg = null;\r\n        this.worldDlg = null;\r\n        this.initial_avatar_x = this.avatar.x;\r\n        this.initial_food_x = this.fruit.x;\r\n        this.path_right_x = this.path.x + this.path.width;\r\n        this.anim_pos_array = [];\r\n        this.jewel_img_arr = [];\r\n        this.jewel_desc_delta = 0;\r\n        this.jewel_anim_order = 0;\r\n        this.arr_idx_arr = [];\r\n        this._quaternion = new Laya.Quaternion();\r\n        this._direction = new Laya.Vector3();\r\n        this.jewel_arr = [];\r\n        this.jewel_expand = true;\r\n        this.orgSky = new Laya.Vector4();\r\n        this.bSkyChange = false;\r\n        this.skyMat = null;\r\n        this.haptic_active = true;\r\n        this.tut_expand = false;\r\n        this.connect();\r\n        this.displaySplash();\r\n        this.jewel_img_arr[0] = this.eat_jewel_img0;\r\n        this.jewel_img_arr[1] = this.eat_jewel_img1;\r\n        this.jewel_img_arr[2] = this.eat_jewel_img2;\r\n        this.jewel_img_arr[3] = this.eat_jewel_img3;\r\n        this.jewel_img_arr[4] = this.eat_jewel_img4;\r\n        this.jewel_img_arr[5] = this.eat_jewel_img5;\r\n        this.jewel_img_arr[6] = this.eat_jewel_img6;\r\n        this.jewel_img_arr[7] = this.eat_jewel_img7;\r\n        this.jewel_img_arr[8] = this.eat_jewel_img8;\r\n        this.jewel_img_arr[9] = this.eat_jewel_img9;\r\n        this.loading_anim.loadAtlas(\"res/atlas/loading.atlas\", Laya.Handler.create(this, this.onLoadingAnimLoaded));\r\n        this.eat_anim.loadAtlas(\"res/atlas/food_particle.atlas\", Laya.Handler.create(this, this.onLoadingAnimLoaded));\r\n    }\r\n    connect() {\r\n        this.btn_setting.on(Laya.Event.MOUSE_DOWN, this, this.showSettingDlg);\r\n        this.btn_customize.on(Laya.Event.MOUSE_DOWN, this, this.showCustomizeDlg);\r\n        this.btn_world.on(Laya.Event.MOUSE_DOWN, this, this.showWorldDlg);\r\n        this.btn_next.on(Laya.Event.MOUSE_DOWN, this, this.nextRound);\r\n        this.btn_continue.on(Laya.Event.MOUSE_DOWN, this, this.restartRound);\r\n    }\r\n    displaySplash() {\r\n        GameUI.progressView = new ProgressView();\r\n        GameUI.progressView.on(\"splash_finish\", this, this.startResourceLoading);\r\n        Laya.stage.addChild(GameUI.progressView);\r\n    }\r\n    startResourceLoading() {\r\n        localStorage.setItem(\"jelly_sound\", \"true\");\r\n        GameUI.progressView.off(\"splash_finish\", this, this.startResourceLoading);\r\n        GameUI.progressView.on(\"load_finish\", this, this.enterRound);\r\n        Laya.loader.create(GameInfo.resArray, Laya.Handler.create(GameUI.progressView, GameUI.progressView.onLoadComplete, null, false));\r\n        Laya.URL.basePath = GameInfo.baseResPath;\r\n    }\r\n    initGameInfo4Food() {\r\n        if (!this.food_pointer)\r\n            return;\r\n        this.food_pointer.updateGameState(GameInfo.GAME_STATE);\r\n        this.food_pointer.updatePassLen(GameInfo.curFoodLen);\r\n    }\r\n    nextRound() {\r\n        Sound.playLevelCompleteSound();\r\n        if (parseInt(this.eat_jewel_cnt.text) > 0) {\r\n            if (GameInfo.isJewelsLevel()) {\r\n                let cj = parseInt(this.current_jewel.text);\r\n                let ej = parseInt(this.eat_jewel_cnt.text);\r\n                cj += ej;\r\n                this.current_jewel.text = cj.toString();\r\n                this.calcJewelAndGoNext();\r\n            }\r\n            else {\r\n                for (let i = 0; i < this.jewel_img_arr.length; i++) {\r\n                    this.arr_idx_arr[i] = Math.floor(Math.random() * 3);\r\n                }\r\n                Laya.timer.loop(100, this, this.animate4Jewel);\r\n            }\r\n        }\r\n        else {\r\n            this.calcJewelAndGoNext();\r\n        }\r\n    }\r\n    animate4Jewel() {\r\n        this.jewel_anim_order++;\r\n        if (parseInt(this.eat_jewel_cnt.text) > 0) {\r\n            Sound.playGemRushGemSound();\r\n            this.eat_jewel_cnt.text = (parseInt(this.eat_jewel_cnt.text) - this.jewel_desc_delta).toString();\r\n            this.current_jewel.text = (parseInt(this.current_jewel.text) + this.jewel_desc_delta).toString();\r\n            for (let i = 0; i < this.jewel_img_arr.length; i++) {\r\n                this.anim_pos_array = GameInfo.anim_pos_category[this.arr_idx_arr[i]];\r\n                if (i >= this.jewel_anim_order)\r\n                    continue;\r\n                let tmp = this.jewel_img_arr[i];\r\n                let img_pos_indr = -1;\r\n                for (let j = 0; j < this.anim_pos_array.length; j++) {\r\n                    if (this.anim_pos_array[j][0] == tmp.x && this.anim_pos_array[j][1] == tmp.y)\r\n                        img_pos_indr = j;\r\n                }\r\n                if (img_pos_indr > -1 && img_pos_indr < this.anim_pos_array.length - 1) {\r\n                    tmp.x = this.anim_pos_array[img_pos_indr + 1][0];\r\n                    tmp.y = this.anim_pos_array[img_pos_indr + 1][1];\r\n                }\r\n            }\r\n        }\r\n        else {\r\n            Laya.timer.clearAll(this);\r\n            this.calcJewelAndGoNext();\r\n        }\r\n    }\r\n    calcJewelAndGoNext() {\r\n        GameInfo.jewelCnt = parseInt(this.current_jewel.text);\r\n        localStorage.setItem(\"jelly_jewel\", this.current_jewel.text);\r\n        this.eat_jewel_cnt.text = \"0\";\r\n        this.jewel_round_current.text = \"0\";\r\n        this.enterRound();\r\n    }\r\n    restartRound() {\r\n        GameInfo.round--;\r\n        localStorage.setItem(\"jelly_round\", GameInfo.round.toString());\r\n        this.enterRound();\r\n    }\r\n    changeHaptic() {\r\n        let haptic = localStorage.getItem(\"jelly_haptic\");\r\n        this.haptic_active = (haptic == \"true\") ? true : false;\r\n    }\r\n    changeSound() {\r\n        let sound = localStorage.getItem(\"jelly_sound\");\r\n        Sound.sound_active = (sound == \"true\") ? true : false;\r\n    }\r\n    initDlgs() {\r\n        this.settingDlg = new SettingDlg();\r\n        this.settingDlg.on(\"close_dlg\", this, this.closeDlg);\r\n        this.settingDlg.on(\"haptic_changed\", this, this.changeHaptic);\r\n        this.settingDlg.on(\"sound_changed\", this, this.changeSound);\r\n        this.customizeDlg = new CustomizeDlg();\r\n        this.customizeDlg.on(\"select_player\", this, this.initPlayer);\r\n        this.customizeDlg.on(\"close_dlg\", this, this.closeDlg);\r\n        this.customizeDlg.on(\"update_jewel\", this, this.updateJewel);\r\n        this.worldDlg = new WorldDlg();\r\n        this.worldDlg.on(\"close_dlg\", this, this.closeDlg);\r\n    }\r\n    enterRound() {\r\n        this.initDlgs();\r\n        GameInfo.InitGameInfo();\r\n        this.initGameInfo4Food();\r\n        this.resetUI();\r\n        let old_scene = Laya.stage.getChildByName(\"jelly_scene\");\r\n        if (old_scene) {\r\n            old_scene.destroy();\r\n            old_scene = null;\r\n            this.curScene = null;\r\n            Laya.Resource.destroyUnusedResources();\r\n        }\r\n        var self = this;\r\n        Laya.loader.load([\r\n            \"res/atlas/Images.atlas\",\r\n            \"res/atlas/resources/icons.atlas\"\r\n        ], Laya.Handler.create(null, function () {\r\n            self.initScene();\r\n        }));\r\n        Laya.URL.basePath = GameInfo.baseResPath;\r\n    }\r\n    initScene() {\r\n        var self = this;\r\n        this.loading_anim.visible = true;\r\n        Laya.Scene3D.load(\"unity/round/terrain\" + GameInfo.terrainNum + \".ls\", Laya.Handler.create(null, function (scene) {\r\n            self.initSceneImpl(scene);\r\n        }));\r\n        Laya.URL.basePath = GameInfo.baseResPath;\r\n    }\r\n    onLoadingAnimLoaded() {\r\n    }\r\n    showFoodEatPtcl() {\r\n        this.eat_anim.visible = true;\r\n    }\r\n    hideFoodEatPtcl() {\r\n        this.eat_anim.visible = false;\r\n    }\r\n    initSceneImpl(scene) {\r\n        this.loading_anim.visible = false;\r\n        this.btn_tuple.visible = true;\r\n        this.curScene = scene;\r\n        this.curScene.name = \"jelly_scene\";\r\n        Laya.stage.addChild(this.curScene);\r\n        Laya.stage.setChildIndex(this.curScene, 0);\r\n        this.curCamera = this.curScene.getChildByName(\"Main Camera\");\r\n        this.curCamera.farPlane = 500;\r\n        this.curCamera.transform.position = new Laya.Vector3(this.curCamera.transform.position.x, this.curCamera.transform.position.y, this.curCamera.transform.position.z - 1);\r\n        GameInfo.scene = this.curScene;\r\n        var dlight = this.curScene.getChildByName(\"Directional light\");\r\n        if (GameInfo.isCurveLevel()) {\r\n            try {\r\n                this.curve_proc();\r\n            }\r\n            catch (e) {\r\n                console.log(\"curve level init...\", e.toString);\r\n            }\r\n        }\r\n        this.pillar_proc();\r\n        if (GameInfo.isJewelsLevel()) {\r\n            this.jewel_proc();\r\n        }\r\n        this.SetSkyInfo();\r\n        this.initPlayer();\r\n        this.initFood();\r\n        this.initUiInfo();\r\n        if (!GameInfo.isJewelsLevel())\r\n            return;\r\n    }\r\n    initPlayer() {\r\n        let model_name_arr = GameInfo.modelName.split('_');\r\n        let group_name = model_name_arr[0];\r\n        let player_name = model_name_arr[1];\r\n        if (model_name_arr[2])\r\n            player_name = player_name += \"_\" + model_name_arr[2];\r\n        if (model_name_arr[3])\r\n            player_name = player_name += \"_\" + model_name_arr[3];\r\n        let pos_vtr;\r\n        let tmp = this.curScene.getChildByName(\"jelly\");\r\n        if (tmp == null) {\r\n            tmp = this.curScene.getChildByName(\"jellyBox\").getChildByName(\"jelly\");\r\n        }\r\n        if (tmp) {\r\n            pos_vtr = tmp.transform.position;\r\n            pos_vtr.y = 0.258;\r\n            tmp.destroy();\r\n            tmp = null;\r\n        }\r\n        let player_list;\r\n        if (!player_list)\r\n            player_list = Laya.loader.getRes(\"unity/model/player.lh\");\r\n        if (player_name == \"Snarglius\")\r\n            group_name = \"heroes\";\r\n        let player_group = player_list.getChildByName(group_name);\r\n        let player_body_org = player_group.getChildByName(player_name);\r\n        this.player_body = Laya.MeshSprite3D.instantiate(player_body_org);\r\n        this.player_body.active = true;\r\n        this.player_body.name = \"jelly\";\r\n        var rigidBody = this.player_body.addComponent(Laya.Rigidbody3D);\r\n        this.player_body.getChildAt(0).getChildAt(0).active = false;\r\n        rigidBody.colliderShape = new Laya.BoxColliderShape(1.3, 1, 1);\r\n        this.player_body.getChildAt(1).name = \"jelly\";\r\n        rigidBody.colliderShape.localOffset.y = 0.5;\r\n        rigidBody.mass = 100;\r\n        rigidBody.friction = 0;\r\n        rigidBody.rollingFriction = 0;\r\n        this.player_body.transform.position = pos_vtr;\r\n        this.player_body.on(\"update_path\", this, this.updateAvatarPath);\r\n        this.player_body.on(\"update_pass\", this, this.updateFeverUp);\r\n        this.player_body.on(\"game_started\", this, this.startRound);\r\n        this.player_body.on(\"game_failed\", this, this.stopRound);\r\n        this.player_body.on(\"game_ended\", this, this.endRound);\r\n        this.player_pointer = this.player_body.addComponent(Player);\r\n        this.player_pointer.startFollow(this.curScene, this.curCamera, 0.2);\r\n        this.setRoundColors(group_name, player_name);\r\n    }\r\n    initFood() {\r\n        let food_idx = GameInfo.GetTargetFoodIndex();\r\n        let food_list = Laya.loader.getRes(\"unity/model/food.lh\");\r\n        let food_tmp = food_list.getChildAt(food_idx);\r\n        if (!food_tmp) {\r\n            return;\r\n        }\r\n        this.food_model = Laya.MeshSprite3D.instantiate(food_tmp);\r\n        this.food_model.name = GameInfo.getFoodName();\r\n        this.food_model.active = true;\r\n        this.food_model.meshRenderer.castShadow = true;\r\n        this.curScene.addChild(this.food_model);\r\n        this.food_model.transform.position = new Laya.Vector3(this.player_body.transform.position.x, this.player_body.transform.position.y + 1, this.player_body.transform.position.z - 3);\r\n        this.food_model.on(\"update_path\", this, this.updateFoodPath);\r\n        this.food_model.on(\"food_destroy\", this, this.destroyFood);\r\n        this.food_pointer = this.food_model.addComponent(Food);\r\n        this.food_pointer.startFollow(this.curScene, this.curCamera);\r\n    }\r\n    setRoundColors(group_name, player_name) {\r\n        GameInfo.setGroundColor(group_name, player_name);\r\n        let cube = this.curScene.getChildByName(\"Cube\").getChildByName(\"Cube (1)\");\r\n        cube.meshRenderer.sharedMaterial.albedoColor = GameInfo.getGroundColor();\r\n        let cube_down_side = this.curScene.getChildByName(\"Cube Down Side\").getChildByName(\"Cube (1)\");\r\n        cube_down_side.meshRenderer.sharedMaterial.albedoColor = GameInfo.getGroundColor();\r\n        let shader_obs_list = this.curScene.getChildByName(\"Level\").getChildByName(\"obstacles\");\r\n        for (let i = 0; i < shader_obs_list.numChildren - 1; i++) {\r\n            let shader_obs_tmp = shader_obs_list.getChildAt(i);\r\n            if (shader_obs_tmp) {\r\n                let shader_obs = shader_obs_tmp.getChildByName(\"particle1\");\r\n                if (shader_obs)\r\n                    for (let j = 0; j < shader_obs.numChildren; j++) {\r\n                        let final_shader = shader_obs.getChildAt(j);\r\n                        if (final_shader)\r\n                            final_shader.meshRenderer.sharedMaterial.albedoColor = GameInfo.getGroundColor();\r\n                    }\r\n            }\r\n        }\r\n        if (!GameInfo.isJewelsLevel())\r\n            return;\r\n        let ground_list = this.curScene.getChildByName(\"Level\").getChildByName(\"1\");\r\n        for (let i = 0; i < ground_list.numChildren - 1; i++) {\r\n            let ground_tmp = ground_list.getChildAt(i);\r\n            if (ground_tmp) {\r\n                try {\r\n                    ground_tmp.meshRenderer.sharedMaterial.albedoColor = GameInfo.getJewelGroundColor();\r\n                }\r\n                catch (e) {\r\n                }\r\n            }\r\n        }\r\n        let jewel_group_list = this.curScene.getChildByName(\"Level\").getChildByName(\"jewels\");\r\n        for (let i = 0; i < jewel_group_list.numChildren - 1; i++) {\r\n            let jewel_group = jewel_group_list.getChildAt(i);\r\n            if (jewel_group)\r\n                for (let j = 0; j < jewel_group.numChildren; j++) {\r\n                    let jewel_item = jewel_group.getChildAt(j);\r\n                    if (jewel_item) {\r\n                        this.jewel_arr.push(jewel_item);\r\n                    }\r\n                }\r\n        }\r\n        Laya.timer.loop(100, this, this.animate4JewelArr);\r\n    }\r\n    animate4JewelArr() {\r\n        let last_jewel = this.jewel_arr[this.jewel_arr.length - 1];\r\n        if (!last_jewel)\r\n            return;\r\n        if (!last_jewel.transform)\r\n            return;\r\n        let current_scale = last_jewel.transform.localScaleX;\r\n        if (Math.abs(current_scale) >= 0.5) {\r\n            if (this.jewel_expand) {\r\n                current_scale += 0.2;\r\n                if (Math.abs(current_scale) > 1)\r\n                    this.jewel_expand = false;\r\n            }\r\n            else {\r\n                current_scale -= 0.2;\r\n                if (Math.abs(current_scale) < 0.5) {\r\n                    this.jewel_expand = true;\r\n                    current_scale = 0.5;\r\n                }\r\n            }\r\n        }\r\n        for (let i = 0; i < this.jewel_arr.length; i++) {\r\n            if (!this.jewel_arr[i])\r\n                continue;\r\n            if (!this.jewel_arr[i].transform)\r\n                continue;\r\n            this.jewel_arr[i].transform.localScaleX = current_scale;\r\n            this.jewel_arr[i].transform.localScaleY = current_scale;\r\n            this.jewel_arr[i].transform.localScaleZ = current_scale;\r\n        }\r\n    }\r\n    SetSkyInfo() {\r\n        if (this.curCamera) {\r\n            this.curCamera.clearFlag = Laya.BaseCamera.CLEARFLAG_SKY;\r\n            this.curCamera.fieldOfView = 60;\r\n            this.StartSkyProc();\r\n        }\r\n    }\r\n    closeDlg() {\r\n        this.updateCustomState(false);\r\n    }\r\n    updateJewel(custom_state) {\r\n        let current_jewel_cnt = localStorage.getItem(\"jelly_jewel\");\r\n        GameInfo.jewelCnt = parseInt(current_jewel_cnt);\r\n        this.current_jewel.text = current_jewel_cnt;\r\n    }\r\n    updateAvatarPath(cur_per) {\r\n        if (cur_per > 1) {\r\n            cur_per = 1;\r\n        }\r\n        else {\r\n            let cur_len = this.path.width * cur_per;\r\n            if (this.path_right_x > this.avatar.x) {\r\n                this.avatar.x = this.initial_avatar_x + cur_len;\r\n            }\r\n        }\r\n    }\r\n    destroyFood() {\r\n        this.food_model.active = false;\r\n        this.food_model.destroy();\r\n        this.food_model = null;\r\n        this.fruit.visible = false;\r\n        GameInfo.targetFoodEat = true;\r\n        let eat_jewel = 50;\r\n        this.jewel_desc_delta = 2;\r\n        if (GameInfo.targetFood % 3 == 2) {\r\n            eat_jewel = 100;\r\n            this.jewel_desc_delta = 4;\r\n        }\r\n        this.eat_jewel_cnt.text = eat_jewel.toString();\r\n        GameInfo.eatJewelCnt = eat_jewel;\r\n        Sound.playCatchFoodSound();\r\n        this.showFoodEatPtcl();\r\n        Laya.timer.once(900, this, function () {\r\n            this.hideFoodEatPtcl();\r\n        });\r\n    }\r\n    updateFoodPath(cur_per) {\r\n        if (cur_per > 1) {\r\n            cur_per = 1;\r\n        }\r\n        else {\r\n            let cur_len = this.path.width * cur_per;\r\n            if (this.path_right_x > this.fruit.x) {\r\n                this.fruit.x = this.initial_food_x + cur_len;\r\n            }\r\n        }\r\n    }\r\n    updateCustomState(state) {\r\n        if (this.player_pointer)\r\n            this.player_pointer.updateCustomState(state);\r\n        if (this.food_pointer)\r\n            this.food_pointer.updateCustomState(state);\r\n    }\r\n    showCustomizeDlg() {\r\n        this.customizeDlg.show();\r\n        this.updateCustomState(true);\r\n        Sound.playCustomizeOpenSound();\r\n    }\r\n    showWorldDlg() {\r\n        this.worldDlg.show();\r\n        this.updateCustomState(true);\r\n        Sound.playCustomizeOpenSound();\r\n    }\r\n    showSettingDlg() {\r\n        this.settingDlg.show();\r\n        this.updateCustomState(true);\r\n        Sound.playCustomizeOpenSound();\r\n    }\r\n    pillar_proc() {\r\n        var translevel = this.curScene.getChildByName(\"Level\");\r\n        var obstacles = translevel.getChildByName(\"obstacles\");\r\n        for (var i = 0; i < obstacles.numChildren; i++) {\r\n            var subObj = obstacles.getChildAt(i);\r\n            for (var j = 0; j < subObj.numChildren - 1; j++) {\r\n                subObj.getChildAt(j).on(\"trigger\", this, this.updateFeverDown);\r\n                subObj.getChildAt(j).addComponent(TriggerCollisionScript);\r\n            }\r\n        }\r\n    }\r\n    curve_proc() {\r\n        var translevel = this.curScene.getChildByName(\"Level\");\r\n        var rd_cols = translevel.getChildByName(\"corner_to_right\");\r\n        for (var i = 0; i < rd_cols.numChildren; i++) {\r\n            var subObj = rd_cols.getChildAt(i);\r\n            subObj.on(\"trigger\", this, this.updatePlayerDir);\r\n            subObj.addComponent(TriggerCollisionScript4Round);\r\n        }\r\n    }\r\n    updatePlayerDir(dir) {\r\n        this.player_pointer.updateDir(dir);\r\n    }\r\n    jewel_proc() {\r\n        var translevel = this.curScene.getChildByName(\"Level\");\r\n        var jewel_groups = translevel.getChildByName(\"jewels\");\r\n        for (var i = 0; i < jewel_groups.numChildren; i++) {\r\n            var subObj = jewel_groups.getChildAt(i);\r\n            for (var j = 0; j < subObj.numChildren; j++) {\r\n                if (!subObj.getChildAt(j))\r\n                    continue;\r\n                subObj.getChildAt(j).on(\"trigger\", this, this.updateJewelBar);\r\n                subObj.getChildAt(j).addComponent(TriggerCollisionScript4Jewel);\r\n            }\r\n        }\r\n    }\r\n    StartSkyProc() {\r\n        let initial_plane_pos = this.curScene.getChildByName(\"Plane\").transform.position;\r\n        this.curScene.getChildByName(\"Plane\").transform.position = new Laya.Vector3(initial_plane_pos.x + 10, initial_plane_pos.y - 5, initial_plane_pos.z + 5);\r\n        this.skyMat = this.curScene.getChildByName(\"Plane\").meshRenderer.material;\r\n        let arr = [\"#ff0000\", \"#00ff00\", \"#0000ff\", \"#ffff00\", \"#00ffff\", \"#ff00ff\"];\r\n        this.skyMat.albedoColor = GameInfo.getSkyColor();\r\n        this.orgSky = GameInfo.getSkyColor();\r\n        this.bSkyChange = false;\r\n        Laya.timer.frameLoop(100, this, this.SkyUpdate);\r\n    }\r\n    SkyUpdate() {\r\n        if (!this.bSkyChange)\r\n            return;\r\n        var deltaColor = new Laya.Vector4();\r\n        Laya.Vector4.subtract(this.targetSkyColor, this.skyMat.albedoColor, deltaColor);\r\n        try {\r\n            this.skyMat.albedoColorR += (deltaColor.x / this.targetSkyStep);\r\n            this.skyMat.albedoColorG += (deltaColor.y / this.targetSkyStep);\r\n            this.skyMat.albedoColorB += (deltaColor.z / this.targetSkyStep);\r\n        }\r\n        catch (e) {\r\n            console.log(\"this.skyMat...\", e.toString());\r\n        }\r\n        this.targetSkyStep--;\r\n        if (this.targetSkyStep == 0)\r\n            this.bSkyChange = false;\r\n    }\r\n    SetTargetSky(color, step) {\r\n        this.targetSkyColor = color;\r\n        this.targetSkyStep = step;\r\n        this.bSkyChange = true;\r\n    }\r\n    setDarkSky() {\r\n        var gray = new Laya.Vector4(0, 0, 0, 1);\r\n        this.skyMat.albedoColor = gray;\r\n    }\r\n    setGraySky() {\r\n        var gray = new Laya.Vector4(0, 0, 0, 1);\r\n        this.SetTargetSky(gray, 20);\r\n    }\r\n    setFeverSky() {\r\n        var dlight = this.curScene.getChildByName(\"Directional light\");\r\n        dlight.color = new Laya.Vector3(0.8, 1, 0.8);\r\n        dlight.intensity = 0.5;\r\n        var fever = new Laya.Vector4(0, 1, 0, 1);\r\n        this.SetTargetSky(fever, 3);\r\n    }\r\n    setOrgSky() {\r\n        var dlight = this.curScene.getChildByName(\"Directional light\");\r\n        dlight.color = new Laya.Vector3(1, 1, 1);\r\n        dlight.intensity = 1;\r\n        this.SetTargetSky(this.orgSky, 3);\r\n    }\r\n    vibration() {\r\n        if (!this.haptic_active)\r\n            return;\r\n        try {\r\n            window.navigator.vibrate(100);\r\n        }\r\n        catch (e) {\r\n            console.log(\"navigator exp...\", e.toString());\r\n        }\r\n    }\r\n    updateFeverUp() {\r\n        this.vibration();\r\n        let tot_cnt = GameInfo.GetObstacleCount();\r\n        if (GameInfo.fever_ok) {\r\n            GameInfo.current_fever--;\r\n            this.player_body.getComponent(Player).ExplodePillar();\r\n            if (GameInfo.current_fever <= 0) {\r\n                GameInfo.fever_ok = false;\r\n                this.setOrgSky();\r\n                this.player_body.getComponent(Player).ZoomInCamera();\r\n            }\r\n            else {\r\n                Sound.playFeverLoopSound();\r\n            }\r\n        }\r\n        else {\r\n            GameInfo.current_fever++;\r\n            this.player_body.getComponent(Player).ShowTrail(true);\r\n            if (GameInfo.current_fever > 1)\r\n                this.setGraySky();\r\n            if (GameInfo.current_fever >= tot_cnt / 3) {\r\n                GameInfo.fever_ok = true;\r\n                this.setFeverSky();\r\n                Sound.playFeverStartSound();\r\n                this.player_body.getComponent(Player).ExplodePillar();\r\n                this.player_body.getComponent(Player).ZoomOutCamera();\r\n            }\r\n        }\r\n        this.fever_bar.value = GameInfo.current_fever / (tot_cnt / 3);\r\n    }\r\n    updateFeverDown(block_cnt) {\r\n        GameInfo.current_fever = 0;\r\n        GameInfo.fever_ok = false;\r\n        this.fever_bar.value = 0;\r\n        this.player_body.getComponent(Player).ShowTrail(false);\r\n        this.setOrgSky();\r\n    }\r\n    updateJewelBar() {\r\n        Sound.playGemRushGemSound();\r\n        this.jewel_bar.value = GameInfo.eatJewelCnt / parseInt(this.jewel_round_total.text);\r\n        GameInfo.eatJewelCnt += 5;\r\n        this.eat_jewel_cnt.text = GameInfo.eatJewelCnt.toString();\r\n        this.jewel_round_current.text = GameInfo.eatJewelCnt.toString();\r\n        this.player_pointer.ShowSpeedParticle();\r\n    }\r\n    startRound() {\r\n        this.updateUI4Start();\r\n        Sound.playGameStartSound();\r\n        if (!GameInfo.isJewelsLevel()) {\r\n            this.food_pointer.start();\r\n        }\r\n    }\r\n    stopRound() {\r\n        Laya.timer.once(700, this, function () {\r\n            this.updateUI4Stop();\r\n            Sound.playFallSound();\r\n        });\r\n    }\r\n    updateUI4Stop() {\r\n        this.failed_note.visible = true;\r\n        this.btn_continue.visible = true;\r\n        this.game_status.visible = false;\r\n        this.fever_bar.visible = false;\r\n        this.jewel_bar_box.visible = false;\r\n    }\r\n    updateUI4Start() {\r\n        this.failed_note.visible = false;\r\n        this.btn_continue.visible = false;\r\n        this.tut_img.visible = false;\r\n        this.tut_bar.visible = false;\r\n        this.btn_setting.visible = false;\r\n        this.btn_tuple.visible = false;\r\n        this.game_logo.visible = false;\r\n        this.game_status.visible = true;\r\n        this.renderLevelBar(true);\r\n    }\r\n    endRound() {\r\n        this.setDarkSky();\r\n        this.updateUI4End();\r\n        this.pillar_end_proc();\r\n        Sound.playReachFinishSound();\r\n        this.showFoodEatPtcl();\r\n        Laya.timer.once(1000, this, function () {\r\n            this.hideFoodEatPtcl();\r\n        });\r\n        Laya.timer.loop(50, this, this.animate4shine);\r\n    }\r\n    animate4shine() {\r\n        this.shine_img.rotation -= 2;\r\n    }\r\n    updateUI4End() {\r\n        if (!GameInfo.isJewelsLevel())\r\n            this.star_bar.visible = true;\r\n        this.btn_next.visible = true;\r\n        this.level_note.visible = true;\r\n        if (parseInt(this.eat_jewel_cnt.text) > 0) {\r\n            this.gem_ret.visible = true;\r\n            this.showJewels();\r\n        }\r\n        else {\r\n            this.hideJewels();\r\n        }\r\n        if (GameInfo.targetFoodEat)\r\n            this.food_ret.visible = true;\r\n        this.game_status.visible = false;\r\n        this.fever_bar.visible = false;\r\n        this.jewel_bar_box.visible = false;\r\n    }\r\n    showJewels() {\r\n        for (let i = 0; i < this.jewel_img_arr.length; i++) {\r\n            this.jewel_img_arr[i].visible = true;\r\n        }\r\n    }\r\n    hideJewels() {\r\n        for (let i = 0; i < this.jewel_img_arr.length; i++) {\r\n            this.jewel_img_arr[i].visible = false;\r\n        }\r\n    }\r\n    resetUI() {\r\n        this.failed_note.visible = false;\r\n        this.btn_continue.visible = false;\r\n        this.gold_star1.visible = false;\r\n        this.gold_star2.visible = false;\r\n        this.gold_star3.visible = false;\r\n        this.star1.visible = true;\r\n        this.star2.visible = true;\r\n        this.star3.visible = true;\r\n        this.star_bar.visible = false;\r\n        this.btn_next.visible = false;\r\n        this.level_note.visible = false;\r\n        this.gem_ret.visible = false;\r\n        this.food_ret.visible = false;\r\n        if (!GameInfo.isJewelsRound)\r\n            this.fruit.visible = true;\r\n        this.avatar.x = this.initial_avatar_x;\r\n        this.fruit.x = this.initial_food_x;\r\n        this.hideJewels();\r\n        let xv = GameInfo.jewel_init_x;\r\n        let yv = GameInfo.jewel_init_y;\r\n        for (let i = 0; i < this.jewel_img_arr.length; i++) {\r\n            this.jewel_img_arr[i].pos(xv, yv);\r\n        }\r\n        this.jewel_anim_order = 0;\r\n        this.jewel_bar.value = 0;\r\n        GameInfo.targetFoodEat = false;\r\n    }\r\n    renderLevelLbl(state) {\r\n        let appl_state = GameInfo.isJewelsLevel() ? state : !state;\r\n        this.gem_rush_lbl.visible = appl_state;\r\n        this.level_bar_box.visible = !appl_state;\r\n    }\r\n    renderLevelBar(state) {\r\n        let appl_state = GameInfo.isJewelsLevel() ? state : !state;\r\n        this.jewel_bar_box.visible = appl_state;\r\n        this.fever_bar.visible = !appl_state;\r\n        this.game_status.visible = !appl_state;\r\n    }\r\n    initUiInfo() {\r\n        this.btn_tuple.visible = true;\r\n        this.current_jewel.visible = true;\r\n        this.jewel_img.visible = true;\r\n        this.game_logo.visible = true;\r\n        this.btn_setting.visible = true;\r\n        this.tut_img.visible = true;\r\n        this.tut_bar.visible = true;\r\n        this.current_jewel.text = GameInfo.jewelCnt.toString();\r\n        this.current_round.text = GameInfo.round.toString();\r\n        let coin = GameInfo.coinCnt % 3;\r\n        if (coin == 0 && GameInfo.coinCnt > 0) {\r\n            this.gold_star1.visible = true;\r\n            this.gold_star2.visible = true;\r\n            this.gold_star3.visible = true;\r\n            this.star1.visible = false;\r\n            this.star2.visible = false;\r\n            this.star3.visible = false;\r\n        }\r\n        else if (coin == 2) {\r\n            this.gold_star1.visible = true;\r\n            this.gold_star2.visible = true;\r\n            this.gold_star3.visible = false;\r\n            this.star1.visible = false;\r\n            this.star2.visible = false;\r\n            this.star3.visible = true;\r\n        }\r\n        else if (coin == 1) {\r\n            this.gold_star1.visible = true;\r\n            this.gold_star2.visible = false;\r\n            this.gold_star3.visible = false;\r\n            this.star1.visible = false;\r\n            this.star2.visible = true;\r\n            this.star3.visible = true;\r\n        }\r\n        if (GameInfo.isJewelsRound) {\r\n            this.jewel_round_total.text = (GameInfo.getRoundJewelCnt() * GameInfo.jewel_unit).toString();\r\n        }\r\n        else {\r\n            this.renderTargetFoodUI();\r\n        }\r\n        this.renderLevelLbl(true);\r\n        GameInfo.current_fever = 0;\r\n        Laya.timer.loop(150, this, this.animate4tut);\r\n    }\r\n    renderTargetFoodUI() {\r\n        let food_arr = GameInfo.getFoodArray();\r\n        let img = [];\r\n        for (let i = 0; i < 3; i++) {\r\n            img[i] = new Laya.Image(\"resources/icons/\" + food_arr[i]);\r\n            Laya.URL.basePath = GameInfo.baseResPath;\r\n            ;\r\n            img[i].width = 60;\r\n            img[i].height = 60;\r\n            img[i].x = 10;\r\n            img[i].y = 10;\r\n            img[i].name = \"target_food\";\r\n        }\r\n        this.check1.visible = (food_arr[0].indexOf(\"disabled\") != -1) ? false : true;\r\n        this.check2.visible = (food_arr[1].indexOf(\"disabled\") != -1) ? false : true;\r\n        this.check3.visible = (food_arr[2].indexOf(\"disabled\") != -1) ? false : true;\r\n        this.food1.removeChildByName(\"target_food\");\r\n        this.food2.removeChildByName(\"target_food\");\r\n        this.food3.removeChildByName(\"target_food\");\r\n        this.food1.addChild(img[0]);\r\n        this.food2.addChild(img[1]);\r\n        this.food3.addChild(img[2]);\r\n        let targetFood = GameInfo.getFoodName();\r\n        let targetIconPath = \"resources/icons/\" + targetFood + \"_enabled.png\";\r\n        this.fruit.removeChildByName(\"fruit_body\");\r\n        let targetImg = new Laya.Image(targetIconPath);\r\n        Laya.URL.basePath = GameInfo.baseResPath;\r\n        targetImg.width = 30;\r\n        targetImg.height = 28;\r\n        this.fruit.addChild(targetImg);\r\n    }\r\n    animate4tut() {\r\n        if (Math.abs(this.tut_img.scaleY) >= 0.7) {\r\n            if (this.tut_expand) {\r\n                this.tut_img.scaleY -= 0.1;\r\n                if (Math.abs(this.tut_img.scaleY) > 1)\r\n                    this.tut_expand = false;\r\n            }\r\n            else {\r\n                this.tut_img.scaleY += 0.1;\r\n                if (Math.abs(this.tut_img.scaleY) < 0.7) {\r\n                    this.tut_expand = true;\r\n                    this.tut_img.scaleY = -0.7;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    pillar_end_proc() {\r\n        var translevel = this.curScene.getChildByName(\"Level\");\r\n        var obstacles = translevel.getChildByName(\"obstacles\");\r\n        for (var i = 0; i < obstacles.numChildren; i++) {\r\n            var subObj = obstacles.getChildAt(i);\r\n            for (var j = 0; j < subObj.numChildren - 1; j++) {\r\n                subObj.getChildAt(j).off(\"trigger\", this, this.updateFeverDown);\r\n            }\r\n        }\r\n    }\r\n}\r\nGameUI.progressView = null;\r\n",
  "references": [
    "F:/zzz/laya-jellyshift-clone/src/ui/layaMaxUI.ts",
    "F:/zzz/laya-jellyshift-clone/src/common/TriggerCollisionScript.ts",
    "F:/zzz/laya-jellyshift-clone/src/common/TriggerCollisionScript4Jewel.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/Player.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/CameraFollow.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/SettingDlg.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/CustomizeDlg.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/ProgressView.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/WorldDlg.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/GameInfo.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/Food.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/Sound.ts",
    "F:/zzz/laya-jellyshift-clone/src/common/TriggerCollisionScript4Round.ts"
  ]
}
