{
  "code": "import { ui } from \"./../ui/layaMaxUI\";\r\nimport GameInfo from \"./../script/GameInfo\";\r\nimport ScrollView from \"./../common/ScrollView\";\r\nimport Sound from \"./Sound\";\r\nclass Item extends Laya.Box {\r\n    constructor(width, height) {\r\n        super();\r\n        this.width = width;\r\n        this.height = height;\r\n        this.graphics.drawRect(0, 0, this.width, this.height, null);\r\n        this.anchorX = 0.5;\r\n        this.anchorY = 0.5;\r\n        this.role = new Laya.Sprite();\r\n        this.role.width = 532;\r\n        this.role.height = 565;\r\n        this.role.scale(0.4, 0.4);\r\n        this.role.pos(this.width / 2, this.height / 2);\r\n        this.addChild(this.role);\r\n        let sound_active = localStorage.getItem(\"jelly_sound\");\r\n        Sound.sound_active = (sound_active == \"true\") ? true : false;\r\n    }\r\n}\r\nexport default class CustomizeDlg extends ui.CustomizeSceneUI {\r\n    constructor() {\r\n        super();\r\n        this.mouse_dir = \"right\";\r\n        this.prev_x = 0;\r\n        this.model_name = \"\";\r\n        this._mouseX = 0;\r\n        this._mouseDown = false;\r\n        this._mouseSpeed = 0;\r\n        this._mouseStartPosX = 0;\r\n        this._curMoveFrame = 0;\r\n        this.selected_arr = [];\r\n        this.repeatTimes = 0;\r\n        this.selectedIdx = 0;\r\n        Laya.timer.frameLoop(1, this, this.onUpdate);\r\n        this.init();\r\n        this.connect();\r\n        this.setScrollView();\r\n    }\r\n    onUpdate() {\r\n        if (!this.visible) {\r\n            return;\r\n        }\r\n        if (!this._mouseDown && this._mouseSpeed != 0) {\r\n            var direction = Math.abs(this._mouseSpeed) / this._mouseSpeed;\r\n            var absSpeed = Math.sqrt(Math.abs(this._mouseSpeed));\r\n            var moveDis = this._mouseSpeed;\r\n            this.updateScrollViewPos(moveDis);\r\n            absSpeed = absSpeed - 0.3;\r\n            if (absSpeed < 1) {\r\n                absSpeed = 0;\r\n                this._mouseSpeed = 0;\r\n                this.centeringControl();\r\n            }\r\n            else {\r\n                this._mouseSpeed = absSpeed * absSpeed * direction;\r\n            }\r\n        }\r\n    }\r\n    setScrollView() {\r\n        this.scrollView = new ScrollView();\r\n        this.addChild(this.scrollView);\r\n        this.initScrollView();\r\n        let array = [];\r\n        let cust_panel = this.getChildByName(\"cust_panel\");\r\n        let len = cust_panel.numChildren;\r\n        for (var i = 0; i < len; i++) {\r\n            array.push(i);\r\n            this.scrollView.addChild(cust_panel.getChildAt(0));\r\n            this.scrollView.getChildAt(i).pos(640 * i, 0);\r\n        }\r\n        this.scrollView.array = array;\r\n        this.scrollView.mouseHandler = new Laya.Handler(this, this.onScrollMouse);\r\n    }\r\n    initScrollView() {\r\n        this.scrollView.leftAlign = 0;\r\n        this.scrollView.rightAlign = 0;\r\n        this.scrollView.space = 0;\r\n        this.scrollView.cellWidth = 640;\r\n        this.scrollView.cellHeight = 0;\r\n        this.scrollView.itemRender = Item;\r\n        this.scrollView.height = 450;\r\n        this.scrollView.width = 640;\r\n        this.scrollView.anchorY = 0.5;\r\n        this.scrollView.pos(0, 550);\r\n    }\r\n    onScrollMouse(e) {\r\n        if (e.type == Laya.Event.MOUSE_DOWN) {\r\n            this.mouseDown();\r\n        }\r\n        else if (e.type == Laya.Event.MOUSE_UP) {\r\n            this.mouseUp();\r\n        }\r\n        else if (e.type == Laya.Event.MOUSE_MOVE) {\r\n            this.mouseMove();\r\n        }\r\n    }\r\n    mouseDown() {\r\n        if (this._mouseDown) {\r\n            console.error(\"mouse had down\");\r\n        }\r\n        this._mouseDown = true;\r\n        this._mouseStartPosX = Laya.MouseManager.instance.mouseX;\r\n        this._mouseX = Laya.MouseManager.instance.mouseX;\r\n    }\r\n    mouseUp() {\r\n        if (!this._mouseDown) {\r\n            return;\r\n        }\r\n        var stableFrame = Laya.timer.currFrame - this._curMoveFrame;\r\n        if (stableFrame > 2) {\r\n            this._mouseSpeed = 0;\r\n            this.centeringControl();\r\n        }\r\n        this._mouseDown = false;\r\n    }\r\n    mouseMove() {\r\n        if (this._mouseDown) {\r\n            var dis = Laya.MouseManager.instance.mouseX - this._mouseX;\r\n            this._mouseX = Laya.MouseManager.instance.mouseX;\r\n            this.updateScrollViewPos(dis);\r\n            this._curMoveFrame = Laya.timer.currFrame;\r\n            this._mouseSpeed = dis;\r\n        }\r\n    }\r\n    updateScrollViewPos(dis) {\r\n        var posX = dis + this.scrollView.x;\r\n        if (posX > 0) {\r\n            posX = 0;\r\n        }\r\n        if (posX < -this.scrollView.width + Laya.stage.width) {\r\n            posX = -this.scrollView.width + Laya.stage.width;\r\n        }\r\n        this.scrollView.pos(posX, this.scrollView.y);\r\n    }\r\n    centeringControl() {\r\n        var centerIndex = this.getScreenCenterCellIndex();\r\n        var cellPosX = this.getCellPosByIndex(centerIndex);\r\n        var posX = Laya.stage.width / 2 - cellPosX;\r\n        Laya.Tween.to(this.scrollView, { x: posX }, 500, Laya.Ease.cubicOut).update = new Laya.Handler(this, null);\r\n        this.showRolePrice();\r\n    }\r\n    getScreenCenterCellIndex() {\r\n        var distance = -this.scrollView.x;\r\n        var index = (distance - this.scrollView.leftAlign + this.scrollView.space + (Laya.stage.width + this.scrollView.cellWidth) / 2) / (this.scrollView.cellWidth + this.scrollView.space);\r\n        return Math.round(index) - 1;\r\n    }\r\n    getCellPosByIndex(index) {\r\n        return this.scrollView.leftAlign + (index + 0.5) * this.scrollView.cellWidth + index * this.scrollView.space;\r\n    }\r\n    showRolePrice() {\r\n        var centerIndex = this.getScreenCenterCellIndex();\r\n        let price = 500;\r\n        this.lbl_price.changeText((price * (centerIndex + 1)).toString());\r\n    }\r\n    init() {\r\n        for (let i = 0; i < GameInfo.models.length; i++) {\r\n            if (GameInfo.models[i].active) {\r\n                let group_name = GameInfo.models[i].sub_category + \"_group\";\r\n                let child_name = GameInfo.models[i].category + \"_\" + GameInfo.models[i].name;\r\n                let child = this.getChildByName(\"cust_panel\").getChildByName(group_name).getChildByName(child_name);\r\n                let question = child.getChildByName(\"question\");\r\n                if (question)\r\n                    question.visible = false;\r\n                let selected = child.getChildByName(\"selected\");\r\n                if (selected)\r\n                    selected.visible = false;\r\n            }\r\n        }\r\n    }\r\n    onClosed() {\r\n        Sound.playCustomizeCloseSound();\r\n        if (this.model_name != \"\" && this.model_name != GameInfo.modelName) {\r\n            GameInfo.modelName = this.model_name;\r\n            this.event(\"select_player\", GameInfo.modelName);\r\n        }\r\n        this.event(\"close_dlg\");\r\n    }\r\n    onUnlock(e) {\r\n        if (e.target.name == \"btn_unlock\") {\r\n            let current_jewel_cnt = parseInt(localStorage.getItem(\"jelly_jewel\"));\r\n            if (current_jewel_cnt < parseInt(this.lbl_price.text)) {\r\n                console.log(\"Not enough jewels!\");\r\n                return;\r\n            }\r\n            let price = parseInt(this.lbl_price.text);\r\n            current_jewel_cnt -= price;\r\n            localStorage.setItem(\"jelly_jewel\", current_jewel_cnt.toString());\r\n            this.event(\"update_jewel\");\r\n            for (let i = 0; i < GameInfo.models.length; i++) {\r\n                if (GameInfo.models[i].price == price && GameInfo.models[i].active == false) {\r\n                    this.selected_arr.push(GameInfo.models[i]);\r\n                }\r\n            }\r\n            Laya.timer.loop(100, this, this.animate4select);\r\n        }\r\n    }\r\n    animate4select() {\r\n        let len = this.selected_arr.length;\r\n        let idx = Math.floor(Math.random() * len);\r\n        Sound.playCustomizeRandomSound();\r\n        for (let i = 0; i < this.selected_arr.length; i++) {\r\n            let group_name = this.selected_arr[i].sub_category + \"_group\";\r\n            let child_name = this.selected_arr[i].category + \"_\" + this.selected_arr[i].name;\r\n            let child = this.scrollView.getChildByName(group_name).getChildByName(child_name);\r\n            let question = child.getChildByName(\"question\");\r\n            if (question)\r\n                question.visible = true;\r\n        }\r\n        let group_name = this.selected_arr[idx].sub_category + \"_group\";\r\n        let child_name = this.selected_arr[idx].category + \"_\" + this.selected_arr[idx].name;\r\n        let child = this.scrollView.getChildByName(group_name).getChildByName(child_name);\r\n        let question = child.getChildByName(\"question\");\r\n        if (question)\r\n            question.visible = false;\r\n        this.repeatTimes++;\r\n        if (this.repeatTimes >= 20) {\r\n            let selected = child.getChildByName(\"selected\");\r\n            if (selected)\r\n                selected.visible = false;\r\n            this.selectedIdx = idx;\r\n            Laya.timer.clearAll(this);\r\n            let jelly_models_str = localStorage.getItem(\"jelly_models\");\r\n            let jelly_models_parent = JSON.parse(jelly_models_str);\r\n            let jelly_models = jelly_models_parent.data;\r\n            jelly_models[this.selected_arr[this.selectedIdx].idx - 1].active = true;\r\n            localStorage.setItem(\"jelly_models\", JSON.stringify({ \"data\": jelly_models }));\r\n            GameInfo.models = jelly_models;\r\n            this.selected_arr = [];\r\n            this.selectedIdx = 0;\r\n            this.repeatTimes = 0;\r\n        }\r\n    }\r\n    selectPlayer(e) {\r\n        if (e.target.name.indexOf(\"_close\") == -1) {\r\n            Sound.playCustomizeSelectSound();\r\n            if (!e.target.getChildByName(\"question\").visible && !e.target.getChildByName(\"selected\").visible) {\r\n                let t = e.target.parent;\r\n                for (let i = 0; i < t.numChildren; i++) {\r\n                    let tt = t.getChildAt(i).getChildByName(\"selected\");\r\n                    if (tt)\r\n                        tt.visible = false;\r\n                }\r\n                e.target.getChildByName(\"selected\").visible = true;\r\n                this.model_name = e.target.name;\r\n            }\r\n        }\r\n    }\r\n    connect() {\r\n        this.btn_unlock.on(Laya.Event.MOUSE_DOWN, this, this.onUnlock);\r\n        this.animals_Bear.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Cat.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Cheetah.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Cock.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Dog.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Duck.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Fox.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Frog.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Hippo.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Lion.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Owl.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Penguin.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Pig.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Racoon.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.animals_Sheep.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_BadGuy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_CaptainAmerica.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_Cowboy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_Deadpool.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_IronMan.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_Magician.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_Princess.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_Robin.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.heroes_PinkGuy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_blue_guy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_bright_blue_girl.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_green_guy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_pink_girl.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_Snarglius.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.jelly_yellow_guy.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Coala.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_CommandoTiger.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Cow.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Crock.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Lama.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Panda.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Rabbit.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Shark.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n        this.legendary_Sloth.on(Laya.Event.MOUSE_DOWN, this, this.selectPlayer);\r\n    }\r\n}\r\n",
  "references": [
    "F:/zzz/laya-jellyshift-clone/src/ui/layaMaxUI.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/GameUI.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/GameInfo.ts",
    "F:/zzz/laya-jellyshift-clone/src/common/ScrollView.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/Sound.ts"
  ]
}
