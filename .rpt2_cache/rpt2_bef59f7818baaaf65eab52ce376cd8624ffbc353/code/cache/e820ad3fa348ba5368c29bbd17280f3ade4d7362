{
  "code": "import GameInfo from \"./GameInfo\";\r\nimport ShadowCollisionScript from \"./../script/ShadowCollisionScript\";\r\nimport ShadowAnimationScript from \"./../script/ShadowAnimationScript\";\r\nimport TriggerCollisionScript from \"../common/TriggerCollisionScript\";\r\nimport Sound from \"./Sound\";\r\nexport default class Player extends Laya.Script3D {\r\n    constructor() {\r\n        super(...arguments);\r\n        this.camera = null;\r\n        this.scene = null;\r\n        this.offset = 0;\r\n        this.rigidbody = null;\r\n        this.speedArr = [];\r\n        this.shadow = null;\r\n        this.player_box = null;\r\n        this.pFollow = null;\r\n        this.player = null;\r\n        this.delta = 0.001;\r\n        this.pillar_const = 1000;\r\n        this.pillar = null;\r\n        this.distance = 0;\r\n        this.length = 0;\r\n        this.cube = null;\r\n        this.cubeDownside = null;\r\n        this.moving = true;\r\n        this.rotating = false;\r\n        this.backMoving = false;\r\n        this.is_start = false;\r\n        this.closeObjectIndex = 0;\r\n        this.distToPillar = 1000;\r\n        this.obstaclesCount = 0;\r\n        this.bMoveState = false;\r\n        this.current_dir = \"z\";\r\n        this.velocity = 0.2;\r\n        this.backdelta = 0.2;\r\n        this.fever = 0;\r\n        this.current_mouseX = 0;\r\n        this.current_mouseY = 0;\r\n        this.stopTime = 0;\r\n        this.camerastart = false;\r\n        this.bCustomize = false;\r\n        this.vdelta = new Laya.Vector3(0, 0, 0);\r\n        this.bEnableMouse = true;\r\n        this.bDownState = false;\r\n        this.rotate_cnt = 0;\r\n        this.calc_idx = 0;\r\n        this.pillar_mat = null;\r\n        this.createdPieceTime = 0;\r\n        this.totalCnt = 0;\r\n    }\r\n    onAwake() {\r\n    }\r\n    EnableCameraAnim(bFlag) {\r\n        var animator1 = this.camera.getComponent(Laya.Animator);\r\n        if (animator1 != null) {\r\n            animator1.enabled = bFlag;\r\n        }\r\n    }\r\n    ZoomInCamera() {\r\n        var animator1 = this.camera.getComponent(Laya.Animator);\r\n        if (animator1 != null && animator1.enabled == true) {\r\n            animator1.play(\"ZoomIn\");\r\n        }\r\n    }\r\n    ZoomOutCamera() {\r\n        var animator1 = this.camera.getComponent(Laya.Animator);\r\n        if (animator1 != null && animator1.enabled == true) {\r\n            animator1.play(\"ZoomOut\");\r\n        }\r\n    }\r\n    StartCamera() {\r\n        var animator1 = this.camera.getComponent(Laya.Animator);\r\n        if (animator1 != null) {\r\n            animator1.play(\"startCamera\");\r\n        }\r\n    }\r\n    EndCamera() {\r\n        var animator1 = this.camera.getComponent(Laya.Animator);\r\n        if (animator1 != null && animator1.enabled == true) {\r\n            animator1.play(\"endCamera\");\r\n        }\r\n        this.ShowEndParticle();\r\n        this.ShowEndParticle();\r\n        this.ShowEndParticle();\r\n    }\r\n    InitPlayerChilds() {\r\n        this.player_box.addChild(this.camera);\r\n        this.AddPlayerTrail();\r\n    }\r\n    updateCustomState(state) {\r\n        this.bCustomize = state;\r\n    }\r\n    mouseDownProc(e) {\r\n        this.bDownState = true;\r\n    }\r\n    mouseUpProc(e) {\r\n        this.bDownState = false;\r\n    }\r\n    mouseMoveProc(e) {\r\n        if (GameInfo.GAME_STATE >= 2 || this.bCustomize == true || !this.bDownState)\r\n            return;\r\n        if (this.bEnableMouse == false)\r\n            return;\r\n        if (this.is_start == false) {\r\n            this.owner.event(\"game_started\");\r\n            this.player.addChild(this.cube);\r\n            this.player.addChild(this.cubeDownside);\r\n            var sky = this.scene.getChildByName(\"Plane\");\r\n            var skypos = new Laya.Vector3(sky.transform.position.x, sky.transform.position.y, sky.transform.position.z);\r\n            var skyRot = new Laya.Vector3(sky.transform.localRotationEuler.x, sky.transform.localRotationEuler.y, sky.transform.localRotationEuler.z);\r\n            this.camera.addChild(sky);\r\n            sky.transform.position = skypos;\r\n            sky.transform.rotationEuler = skyRot;\r\n            this.obstaclesCount = GameInfo.GetObstacleCount();\r\n            var subModel1 = this.player.getChildAt(1);\r\n            var animator1 = subModel1.getComponent(Laya.Animator);\r\n            if (!animator1)\r\n                animator1 = subModel1.getChildAt(0).getComponent(Laya.Animator);\r\n            if (animator1) {\r\n                animator1.play(\"startCharacter\");\r\n            }\r\n            this.bMoveState = true;\r\n            this.is_start = true;\r\n            this.StartCamera();\r\n            var temp = this.player.transform.localPosition;\r\n            this.initpos.setValue(0, temp.y, 0);\r\n            this.SetShadowScriptToParticles();\r\n        }\r\n        let offset_dir = \"down\";\r\n        let delta_y = Laya.stage.mouseY - this.current_mouseY;\r\n        if (delta_y < 0)\r\n            offset_dir = \"up\";\r\n        let val_a = 1.9, val_b = 2.1;\r\n        let lim_a = 0.25, lim_b = 1.95;\r\n        if (Math.abs(delta_y) > 2) {\r\n            let numY = this.player.transform.localScale.y;\r\n            let numX = this.player.transform.localScale.x;\r\n            if (offset_dir == \"up\") {\r\n                numY += 0.1;\r\n                if (numY > lim_b)\r\n                    numY = lim_b;\r\n            }\r\n            if (offset_dir == \"down\") {\r\n                numY -= 0.1;\r\n                if (numY < lim_a)\r\n                    numY = lim_a;\r\n            }\r\n            numX = (val_b - numY) * val_a / val_b;\r\n            this.player.transform.localScale = new Laya.Vector3(numX, numY, this.player.transform.localScale.z);\r\n        }\r\n        this.current_mouseY = Laya.stage.mouseY;\r\n        this.rigidbody.colliderShape.localOffset.y = this.player.transform.localScale.y / 2;\r\n    }\r\n    onUpdate() {\r\n        if (GameInfo.GAME_STATE == 2) {\r\n            return;\r\n        }\r\n        if (this.current_dir == \"z\" || this.current_dir == \"x\") {\r\n            this.bEnableMouse = true;\r\n        }\r\n        if (this.bEnableMouse) {\r\n            Laya.stage.on(Laya.Event.MOUSE_DOWN, this, this.mouseDownProc);\r\n            Laya.stage.on(Laya.Event.MOUSE_UP, this, this.mouseUpProc);\r\n            Laya.stage.on(Laya.Event.MOUSE_MOVE, this, this.mouseMoveProc);\r\n            this.InitPlayerRoatate();\r\n        }\r\n        if (!this.is_start) {\r\n            return;\r\n        }\r\n        if (this.bMoveState) {\r\n            if (this.current_dir == \"z\") {\r\n                this.vdelta.z = this.velocity;\r\n            }\r\n            else if (this.current_dir == \"x\") {\r\n                this.vdelta.x = (-1) * this.velocity;\r\n                this.vdelta.z = 0;\r\n                this.initpos.z = 1;\r\n            }\r\n            else {\r\n                if (this.camPos) {\r\n                    this.camera.transform.position = this.camPos.transform.position;\r\n                    this.camera.transform.rotation = this.camPos.transform.rotation;\r\n                }\r\n                if (this.current_dir == \"r1_1\") {\r\n                    this.bEnableMouse = false;\r\n                    this.vdelta.z = this.velocity * Math.sin(75 / 180 * 3.14);\r\n                    this.vdelta.x = (-1) * this.velocity * Math.cos(75 / 180 * 3.14);\r\n                    if (this.rotate_cnt == 0) {\r\n                        this.player.transform.rotate(new Laya.Vector3(0, -30, 0), true, false);\r\n                        this.rotate_cnt = 1;\r\n                        this.camPos = this.scene.addChild(new Laya.MeshSprite3D(Laya.PrimitiveMesh.createBox(this.delta, this.delta, this.delta)));\r\n                        this.camPos.meshRenderer.enable = false;\r\n                        this.player.addChild(this.camPos);\r\n                        this.camPos.transform.position = this.camera.transform.position;\r\n                        this.camPos.transform.rotation = this.camera.transform.rotation;\r\n                        this.EnableCameraAnim(false);\r\n                    }\r\n                }\r\n                else if (this.current_dir == \"r1_2\") {\r\n                    this.bEnableMouse = false;\r\n                    this.vdelta.z = this.velocity * Math.sin(45 / 180 * 3.14);\r\n                    this.vdelta.x = (-1) * this.velocity * Math.cos(45 / 180 * 3.14);\r\n                    if (this.rotate_cnt == 1) {\r\n                        this.player.transform.rotate(new Laya.Vector3(0, -30, 0), true, false);\r\n                        this.rotate_cnt = 2;\r\n                    }\r\n                }\r\n                else if (this.current_dir == \"r1_3\") {\r\n                    this.bEnableMouse = false;\r\n                    this.vdelta.z = this.velocity * Math.sin(15 / 180 * 3.14);\r\n                    this.vdelta.x = (-1) * this.velocity * Math.cos(15 / 180 * 3.14);\r\n                    if (this.rotate_cnt == 2) {\r\n                        this.player.transform.rotate(new Laya.Vector3(0, -30, 0), true, false);\r\n                        this.rotate_cnt = 3;\r\n                    }\r\n                }\r\n            }\r\n            if (GameInfo.fever_ok) {\r\n                let p = 0.07;\r\n                if (this.current_dir == \"z\")\r\n                    this.vdelta.z += p;\r\n            }\r\n            this.player_box.transform.translate(this.vdelta, true);\r\n        }\r\n        else {\r\n            Sound.playHitObstacleSound();\r\n            if (this.stopTime == 0) {\r\n                this.stopTime = Laya.timer.currTimer;\r\n                this.velocity = GameInfo.org_velocity;\r\n            }\r\n            else if (Laya.timer.currTimer - this.stopTime > 300) {\r\n                this.stopTime = 0;\r\n                this.bMoveState = true;\r\n            }\r\n            if (this.current_dir == \"z\")\r\n                this.player_box.transform.localPosition = new Laya.Vector3(this.player_box.transform.localPosition.x, this.player_box.transform.localPosition.y, this.player_box.transform.localPosition.z - this.backdelta);\r\n            else if (this.current_dir == \"x\")\r\n                this.player_box.transform.localPosition = new Laya.Vector3(this.player_box.transform.localPosition.x + this.backdelta, this.player_box.transform.localPosition.y, this.player_box.transform.localPosition.z);\r\n            return;\r\n        }\r\n        this.pillar = this.FindClosestPillar();\r\n        if (!this.pillar)\r\n            return;\r\n        this.distance = Laya.Vector3.distance(this.player.transform.position, this.pillar.transform.position);\r\n        if (this.closeObjectIndex == this.obstaclesCount - 1) {\r\n            if (GameInfo.GAME_STATE == 3 && this.distance < 0.5) {\r\n                this.SetNextCloseIndex();\r\n            }\r\n            else {\r\n                GameInfo.GAME_STATE = 3;\r\n                this.player.transform.localPosition = this.initpos;\r\n                if (this.cube && this.cubeDownside) {\r\n                    this.cube.removeSelf();\r\n                    this.cubeDownside.removeSelf();\r\n                    this.cube = null;\r\n                    this.cubeDownside = null;\r\n                }\r\n            }\r\n            return;\r\n        }\r\n        if (this.closeObjectIndex < this.obstaclesCount - 1) {\r\n            this.initpos.y = this.player.transform.localPosition.y;\r\n            this.player.transform.localPosition = this.initpos;\r\n        }\r\n        this.length = this.distance;\r\n        let position = new Laya.Vector3(0, 0, this.length + 0.2);\r\n        if (this.distance < 1000 && this.distance > 0) {\r\n            this.cube.transform.localPosition = position;\r\n            this.cubeDownside.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n            let x_delta = Math.abs(this.player.transform.position.x - this.pillar.transform.position.x);\r\n            let z_delta = Math.abs(this.player.transform.position.z - this.pillar.transform.position.z);\r\n            if (x_delta < 1 || this.current_dir == \"x\") {\r\n                this.cube.transform.localScale = new Laya.Vector3(1.3, 1, 0.1);\r\n                this.cubeDownside.transform.localScale = new Laya.Vector3(1.3, 1, this.length);\r\n                this.cube.active = true;\r\n                this.cubeDownside.active = true;\r\n            }\r\n            else {\r\n                this.cube.active = false;\r\n                this.cubeDownside.active = false;\r\n            }\r\n        }\r\n        else {\r\n            GameInfo.GAME_STATE = 2;\r\n        }\r\n        this.updateGameInfo();\r\n    }\r\n    updateDir(dir) {\r\n        this.current_dir = dir;\r\n    }\r\n    InitPlayerRoatate() {\r\n        var delta = this.player.transform.localRotationEuler;\r\n        var target = new Laya.Vector3(0, 0, 0);\r\n        if (this.current_dir == \"x\")\r\n            target.y = -90;\r\n        Laya.Vector3.subtract(target, delta, delta);\r\n        this.player.transform.rotate(delta, true, false);\r\n    }\r\n    ShowSpeedParticle() {\r\n        let particles = Laya.loader.getRes(\"unity/model/particle.lh\");\r\n        let tmp = particles.getChildAt(2);\r\n        if (!tmp) {\r\n            return;\r\n        }\r\n        var dup = Laya.MeshSprite3D.instantiate(tmp);\r\n        this.player_box.addChild(dup);\r\n        dup.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        dup.transform.localScale = new Laya.Vector3(1, 1, 1);\r\n        dup.transform.localPosition.y += 0.5;\r\n        dup.active = true;\r\n    }\r\n    HideWndParticle() {\r\n        var wnd = this.player_box.getChildByName(\"wnd\");\r\n        ;\r\n        if (wnd) {\r\n            wnd.active = false;\r\n            return;\r\n        }\r\n    }\r\n    ShowWndParticle() {\r\n        var wnd = this.player_box.getChildByName(\"wnd\");\r\n        ;\r\n        if (wnd) {\r\n            wnd.active = true;\r\n            return;\r\n        }\r\n        let particles = Laya.loader.getRes(\"unity/model/particle.lh\");\r\n        let tmp = particles.getChildAt(4);\r\n        if (!tmp) {\r\n            return;\r\n        }\r\n        var dup = Laya.MeshSprite3D.instantiate(tmp);\r\n        this.player_box.addChild(dup);\r\n        dup.name = \"wnd\";\r\n        dup.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        dup.transform.localScale = new Laya.Vector3(1, 1, 1);\r\n        dup.transform.localPosition.y += 1;\r\n        dup.active = true;\r\n    }\r\n    ShowEndParticle() {\r\n        let particles = Laya.loader.getRes(\"unity/model/particle.lh\");\r\n        let tmp = particles.getChildAt(0);\r\n        if (!tmp) {\r\n            return;\r\n        }\r\n        var dup = Laya.MeshSprite3D.instantiate(tmp);\r\n        this.player.addChild(dup);\r\n        dup.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        var delta = new Laya.Vector3(0, 0, 0);\r\n        Laya.Vector3.subtract(this.camera.transform.position, this.player.transform.position, delta);\r\n        Laya.Vector3.normalize(delta, delta);\r\n        Laya.Vector3.scale(delta, 5, delta);\r\n        Laya.Vector3.add(dup.transform.position, delta, dup.transform.position);\r\n        dup.transform.localScale = new Laya.Vector3(2, 2, 2);\r\n        dup.active = true;\r\n    }\r\n    SetShadowScriptToParticles() {\r\n        var translevel = this.scene.getChildByName(\"Level\");\r\n        var obstacles = translevel.getChildByName(\"obstacles\");\r\n        var subObj = obstacles.getChildAt(this.closeObjectIndex);\r\n        var particleObj = subObj.getChildByName(\"particle1\");\r\n        particleObj.addComponent(ShadowAnimationScript);\r\n    }\r\n    AddPlayerTrail() {\r\n        let trailCube = Laya.loader.getRes(\"unity/trail/Cube.lh\");\r\n        let tcube = Laya.Sprite3D.instantiate(trailCube);\r\n        tcube.transform.position = this.player.transform.position;\r\n        tcube.transform.position.y += 0.8;\r\n        this.player_box.addChild(tcube);\r\n        tcube.name = \"trail\";\r\n        tcube.getChildAt(0).meshRenderer.enable = false;\r\n        tcube.getChildAt(0).getChildAt(0).trailRenderer.material.color = new Laya.Vector4(0, 0.5, 0, 0.1);\r\n        tcube.active = false;\r\n    }\r\n    ShowTrail(flag) {\r\n        this.player_box.getChildByName(\"trail\").active = flag;\r\n    }\r\n    updateGameInfo() {\r\n        let maxlen = GameInfo.getTerrainLength(GameInfo.round);\r\n        if (GameInfo.curPassedLen > maxlen)\r\n            GameInfo.curPassedLen = maxlen;\r\n        else\r\n            GameInfo.curPassedLen += this.velocity;\r\n        this.owner.event(\"update_path\", GameInfo.curPassedLen / maxlen);\r\n    }\r\n    startFollow(sprite, cam, dz) {\r\n        this.rotate_cnt = 0;\r\n        this.scene = sprite;\r\n        this.camera = cam;\r\n        this.offset = dz;\r\n        this.player = this.owner;\r\n        this.rigidbody = this.owner.getComponent(Laya.Rigidbody3D);\r\n        this.initpos = new Laya.Vector3(0, 0, 0);\r\n        this.cube = this.scene.getChildByName(\"Cube\");\r\n        if (!this.cube.getChildAt(0).getComponent(ShadowCollisionScript))\r\n            this.cube.getChildAt(0).addComponent(ShadowCollisionScript);\r\n        this.cubeDownside = this.scene.getChildByName(\"Cube Down Side\");\r\n        var tmp = this.scene.getChildByName(\"jellyBox\");\r\n        if (tmp == null)\r\n            this.player_box = this.scene.addChild(new Laya.MeshSprite3D(Laya.PrimitiveMesh.createBox(this.delta, this.delta, this.delta)));\r\n        else\r\n            this.player_box = tmp;\r\n        this.player_box.name = \"jellyBox\";\r\n        this.player_box.addChild(this.player);\r\n        this.InitPlayerChilds();\r\n        let sound_active = localStorage.getItem(\"jelly_sound\");\r\n        Sound.sound_active = (sound_active == \"true\") ? true : false;\r\n    }\r\n    onDestroy() {\r\n    }\r\n    ShowParticle() {\r\n        var clone = Laya.Sprite3D.instantiate(this.particlePrefab);\r\n        this.player.addChild(clone);\r\n        clone.transform.localPosition = new Laya.Vector3(0, 0, 0);\r\n        clone.active = true;\r\n    }\r\n    onCollisionEnter(collision) {\r\n    }\r\n    FindClosestPillar() {\r\n        var translevel = this.scene.getChildByName(\"Level\");\r\n        var obstacles = translevel.getChildByName(\"obstacles\");\r\n        var subObj = obstacles.getChildAt(this.closeObjectIndex);\r\n        return subObj;\r\n    }\r\n    ExplodePillar() {\r\n        if (!GameInfo.fever_ok)\r\n            return;\r\n        let translevel = this.scene.getChildByName(\"Level\");\r\n        let obstacles = translevel.getChildByName(\"obstacles\");\r\n        let subObj = obstacles.getChildAt(this.closeObjectIndex - 1);\r\n        let tmp = subObj.getChildAt(0).meshRenderer;\r\n        if (!tmp) {\r\n            return;\r\n        }\r\n        this.pillar_mat = tmp.material;\r\n        this.pieceArray = new Array(subObj.numChildren);\r\n        for (var i = 0; i < subObj.numChildren - 1; i++) {\r\n            var trigger = subObj.getChildAt(i).getComponent(TriggerCollisionScript);\r\n            trigger.onTriggerEnter(this.player.getComponent(Laya.PhysicsComponent));\r\n        }\r\n        this.createdPieceTime = Laya.timer.currTimer;\r\n        this.explosionRadiusCenter = this.player.transform.position;\r\n    }\r\n    disablePillarsCollider() {\r\n        if (!GameInfo.fever_ok)\r\n            return;\r\n        var subObj = this.FindClosestPillar();\r\n        for (var i = 0; i < subObj.numChildren - 1; i++) {\r\n            var col = subObj.getChildAt(i).getComponent(Laya.PhysicsCollider);\r\n            col.colliderShape.localOffset.y = -1;\r\n            col.colliderShape.updateLocalTransformations();\r\n        }\r\n    }\r\n    SetNextCloseIndex() {\r\n        this.distToPillar = 1000;\r\n        this.closeObjectIndex++;\r\n        this.ShowSpeedParticle();\r\n        if (this.closeObjectIndex >= this.obstaclesCount) {\r\n            GameInfo.GAME_STATE = 2;\r\n            this.rigidbody.enabled = false;\r\n            this.player.transform.localPosition = this.initpos;\r\n            this.InitPlayerRoatate();\r\n            this.player.transform.localScale = new Laya.Vector3(1, 1, 1);\r\n            var subModel = this.player.getChildAt(1);\r\n            var self = this;\r\n            Laya.timer.once(100, this, function () {\r\n                var animator = subModel.getComponent(Laya.Animator);\r\n                if (animator != null) {\r\n                    animator.play(\"endCharacter\");\r\n                }\r\n                this.EndCamera();\r\n                self.owner.event(\"game_ended\");\r\n                this.HideWndParticle();\r\n            });\r\n            return;\r\n        }\r\n        this.owner.event(\"update_pass\");\r\n        if (this.closeObjectIndex < this.obstaclesCount - 1) {\r\n            this.SetShadowScriptToParticles();\r\n            Sound.playFeverDestroySound();\r\n        }\r\n        else\r\n            this.distToPillar = 1000;\r\n        return;\r\n    }\r\n    onTriggerStay(other) {\r\n        if (GameInfo.GAME_STATE == 4)\r\n            return;\r\n        if (other.owner == null)\r\n            return;\r\n        if (other.owner.name != \"Check\")\r\n            return;\r\n        if (this.player.transform.localScaleY < 0.9)\r\n            return;\r\n        GameInfo.GAME_STATE = 4;\r\n        this.is_start = false;\r\n        var force = new Laya.Vector3(0, -10, 0);\r\n        this.rigidbody.applyForce(force);\r\n        this.owner.event(\"game_failed\");\r\n        this.HideWndParticle();\r\n    }\r\n}\r\nclass AnimatorStateScriptDemo extends Laya.AnimatorStateScript {\r\n    constructor() {\r\n        super();\r\n    }\r\n    onStateEnter() {\r\n    }\r\n    onStateUpdate() {\r\n    }\r\n    onStateExit() {\r\n    }\r\n}\r\n",
  "references": [
    "F:/zzz/laya-jellyshift-clone/src/script/GameInfo.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/ShadowCollisionScript.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/ShadowAnimationScript.ts",
    "F:/zzz/laya-jellyshift-clone/src/common/TriggerCollisionScript.ts",
    "F:/zzz/laya-jellyshift-clone/src/script/Sound.ts"
  ]
}
